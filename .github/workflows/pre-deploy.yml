name: Pre-Deployment Validation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  pre-deploy-checks:
    name: Run Pre-Deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          npm ci
          cd functions && npm ci && cd ..

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Validate Firebase Configuration
        run: |
          echo "âœ“ Checking firebase.json..."
          test -f firebase.json || (echo "âŒ firebase.json not found" && exit 1)

          echo "âœ“ Checking firestore.rules..."
          test -f firestore.rules || (echo "âŒ firestore.rules not found" && exit 1)

          echo "âœ“ Checking functions/index.js..."
          test -f functions/index.js || (echo "âŒ functions/index.js not found" && exit 1)

      - name: Run Syntax Checks
        run: |
          echo "âœ“ Checking JavaScript syntax..."
          node --check functions/index.js

          echo "âœ“ Checking Firestore Rules syntax..."
          firebase deploy --only firestore:rules --dry-run

      - name: Run Security Audit
        run: |
          echo "âœ“ Checking for security vulnerabilities..."
          cd functions
          npm audit --audit-level=high || echo "âš ï¸  Security warnings found"
          cd ..

      - name: Run All Tests
        run: |
          echo "âœ“ Running function tests..."
          npm run test:functions

          echo "âœ“ Running frontend tests..."
          npm run test:frontend

          echo "âœ“ Running Firestore rules tests..."
          firebase emulators:start --only firestore &
          EMULATOR_PID=$!
          sleep 10
          npm run test:rules || TEST_FAILED=1
          kill $EMULATOR_PID || true

          if [ "$TEST_FAILED" = "1" ]; then
            echo "âŒ Tests failed!"
            exit 1
          fi

      - name: Dry-Run Deployment
        run: |
          echo "âœ“ Testing deployment configuration..."
          firebase deploy --dry-run

      - name: Check Environment Variables
        run: |
          echo "âœ“ Checking required environment variables..."
          # Add checks for required env vars here
          echo "WEBHOOK_URL check..."
          echo "APP_BASE_URL check..."

      - name: Generate Deployment Report
        if: always()
        run: |
          echo "# Deployment Readiness Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**Environment:** ${{ inputs.environment }}" >> deployment-report.md
          echo "**Date:** $(date)" >> deployment-report.md
          echo "**Commit:** ${{ github.sha }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## Checks Performed" >> deployment-report.md
          echo "- âœ… Firebase Configuration" >> deployment-report.md
          echo "- âœ… Syntax Validation" >> deployment-report.md
          echo "- âœ… Security Audit" >> deployment-report.md
          echo "- âœ… Test Suite" >> deployment-report.md
          echo "- âœ… Deployment Dry-Run" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## Status" >> deployment-report.md
          echo "ğŸ‰ **Ready for deployment!**" >> deployment-report.md

      - name: Upload Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Pre-Deployment Validation Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Environment: ${{ inputs.environment }}"
          echo "All checks passed! Ready to deploy."
          echo ""
          echo "To deploy, run:"
          echo "  firebase deploy --only functions,firestore:rules,hosting"
