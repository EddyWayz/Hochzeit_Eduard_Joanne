<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Hochzeit Eduard & Joanne</title>

  <!-- Farbvariablen und Basis‑Styles -->
  <link rel="stylesheet" href="assets/css/variables.css">
  <link rel="stylesheet" href="assets/css/basic.css">
  <link rel="stylesheet" href="assets/css/admin.css">
  <!-- Toast Notifications -->
  <link rel="stylesheet" href="assets/css/toast.css">

  <!-- Header/Footer Include (vanilla) -->
  <script defer src="assets/js/includeTemplate.js"></script>

  <!-- Configuration -->
  <script src="config.js"></script>

  <!-- Utilities -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/toast.js"></script>

  <!-- Firebase SDKs (Updated to v11) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage-compat.js"></script>

  <script>
    firebase.initializeApp(CONFIG.firebase);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const storage = firebase.storage();
  </script>

  <style>
    /* RSVP table visual tweaks */
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--color-border); }
    thead th { position: sticky; top: 0; background: var(--color-surface); }
    .group-header td { background: var(--color-primary-light); font-weight: bold; }
    .family-header td { background: var(--color-surface); font-style: italic; }
    .info-row td { background: #f9f9f9; font-size: 0.9rem; }
    /* Gifts admin small bits */
    .gift-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .gift-form .full { grid-column: 1 / -1; }
    .gift-list img { width: 80px; height: 60px; object-fit: contain; background: #fff; border: 1px solid #eee; border-radius: 6px; }
    .status-pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.85rem; }
    .status-ok { background: #e7f7ee; color: #146c43; border: 1px solid #b7e4c7; }
    .status-res { background: #fff3cd; color: #8a6d3b; border: 1px solid #ffe69c; }
  </style>
</head>
<body>
  <div id="header"></div>

<!-- Admin-Bereich: Login und RSVP-Übersicht als Tabelle -->
  <div id="login" class="card admin-login">
    <div class="card-header">Admin Login</div>
    <div class="card-body">
      <input id="email"    type="email"    placeholder="E‑Mail">
      <input id="password" type="password" placeholder="Passwort">
      <div class="actions" style="justify-content:flex-end; gap: .5rem;">
        <button id="btnLogin">Einloggen</button>
      </div>
    </div>
  </div>

  <!-- Admin Shell with tabs -->
  <main id="adminShell" class="admin-wrap" style="display:none;">
    <div class="admin-header">
      <h1 style="margin:0;">Admin Konsole</h1>
      <div class="actions"><button id="btnLogout" class="btn-outline">Logout</button></div>
    </div>
    <nav class="admin-tabs">
      <button class="admin-tab active" data-tab="giftAdmin">Geschenke</button>
      <button class="admin-tab" data-tab="rsvpSection">RSVPs</button>
    </nav>

    <!-- RSVP Tab -->
    <section id="rsvpSection" class="admin-section">
      <div class="stats">
        <div class="stat"><h4>Familien zugesagt</h4><div id="statYesFamilies" class="value">–</div></div>
        <div class="stat"><h4>Gäste zugesagt</h4><div id="statYesGuests" class="value">–</div></div>
        <div class="stat"><h4>Familien abgesagt</h4><div id="statNoFamilies" class="value">–</div></div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="rsvp-toolbar">
            <input id="rsvpSearch" class="search" type="search" placeholder="Suche (Familie, E‑Mail, Gast)">
            <div class="pill-group">
              <button type="button" class="pill active" data-rsvp="all">Alle</button>
              <button type="button" class="pill" data-rsvp="yes">Zugesagt</button>
              <button type="button" class="pill" data-rsvp="no">Abgesagt</button>
            </div>
            <select id="rsvpSort" class="pill">
              <option value="date_desc">Neueste zuerst</option>
              <option value="date_asc">Älteste zuerst</option>
              <option value="name_az">Familie A–Z</option>
            </select>
            <button id="rsvpExport" class="btn-outline">Export CSV</button>
          </div>
          <div id="rsvpList" class="rsvp-cards"></div>
        </div>
      </div>
    </section>

  <!-- Geschenke verwalten -->
  <section id="giftAdmin" class="admin-section active">
    <h2>Geschenke verwalten</h2>
    <div class="stats">
      <div class="stat"><h4>Geschenke gesamt</h4><div id="giftStatTotal" class="value">–</div></div>
      <div class="stat"><h4>Reserviert</h4><div id="giftStatReserved" class="value">–</div></div>
      <div class="stat"><h4>Frei</h4><div id="giftStatFree" class="value">–</div></div>
    </div>
    <div class="card">
      <div class="card-header">Geschenk hinzufügen</div>
      <div class="card-body">
    <form id="giftForm" class="gift-form">
      <div class="full">
        <label for="gName">Name *</label>
        <input id="gName" type="text" required placeholder="z.B. Reisekasse">
      </div>
      <div class="full">
        <label for="gDesc">Beschreibung</label>
        <textarea id="gDesc" placeholder="Kurze Beschreibung"></textarea>
      </div>
      <div>
        <label for="gLink">Kauflink (optional)</label>
        <input id="gLink" type="url" placeholder="https://…">
        <button type="button" id="fetchImgBtn" class="btn-outline" style="margin-top:.4rem;">Bild aus Link holen</button>
      </div>
      <div>
        <label for="gImg">Bild (URL oder Datei)</label>
        <input id="gImgUrl" type="url" placeholder="https://… (oder leer lassen)">
        <input id="gImgFile" type="file" accept="image/*" style="margin-top: .25rem;">
        <div id="gImgPreviewWrap" class="img-preview">
          <img id="gImgPreview" alt="Vorschau">
          <span class="note">Vorschau</span>
        </div>
      </div>
      <div class="actions full">
        <button type="submit">Geschenk hinzufügen</button>
        <button type="button" id="giftReset">Formular leeren</button>
      </div>
    </form>
      </div>
    </div>

    <div class="card" style="margin-top: var(--space-lg);">
      <div class="card-body">
      <div class="toolbar">
        <input id="giftSearch" class="search" type="search" placeholder="Suchen (Name, Beschreibung)">
        <div class="pill-group">
          <button type="button" class="pill active" data-status="all">Alle</button>
          <button type="button" class="pill" data-status="free">Frei</button>
          <button type="button" class="pill" data-status="reserved">Reserviert</button>
        </div>
      </div>
    <div class="gift-list table-wrap">
      <table id="giftTable">
        <thead>
          <tr>
            <th>Bild</th>
            <th>Name</th>
            <th>Beschreibung</th>
            <th>Link</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
      </div>
    </div>
  </section>

  </main>

  <div id="footer"></div>

  <script>
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const adminShell = document.getElementById('adminShell');

    btnLogin.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const pw    = document.getElementById('password').value;

      // Validate input
      if (!email || !pw) {
        toast.error('Bitte E-Mail und Passwort eingeben');
        return;
      }

      if (!validateEmail(email)) {
        toast.error('Bitte eine gültige E-Mail-Adresse eingeben');
        return;
      }

      // Rate limiting check
      if (!checkRateLimit('admin_login', 5, 300000)) { // 5 attempts per 5 minutes
        toast.error('Zu viele Anmeldeversuche. Bitte warte 5 Minuten und versuche es erneut.');
        return;
      }

      btnLogin.disabled = true;
      const originalText = btnLogin.textContent;
      btnLogin.textContent = 'Anmelden...';

      try {
        await auth.signInWithEmailAndPassword(email, pw);
        document.getElementById('login').style.display = 'none';
        adminShell.style.display = '';
        btnLogout.style.display = '';
        toast.success('Erfolgreich angemeldet');
        initTabs();
        loadRSVPs();
        initGiftsAdmin();
      } catch (err) {
        console.error('Login error:', err);
        let errorMessage = 'Login fehlgeschlagen: ' + err.message;

        if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
          errorMessage = 'E-Mail oder Passwort ist falsch';
        } else if (err.code === 'auth/too-many-requests') {
          errorMessage = 'Zu viele fehlgeschlagene Anmeldeversuche. Bitte versuche es später erneut.';
        } else if (err.code === 'auth/network-request-failed') {
          errorMessage = 'Netzwerkfehler. Bitte überprüfe deine Internetverbindung.';
        }

        toast.error(errorMessage);
      } finally {
        btnLogin.disabled = false;
        btnLogin.textContent = originalText;
      }
    });

    btnLogout.addEventListener('click', async () => {
      try { await auth.signOut(); } catch {}
      location.reload();
    });

    function initTabs() {
      const tabs = document.querySelectorAll('.admin-tab');
      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const id = t.dataset.tab;
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }));
    }

    async function loadRSVPs() {
      const snapshot = await db.collection('rsvps').get();

      const families = [];
      snapshot.forEach(doc => {
        const d = doc.data();
        families.push({
          id: doc.id,
          fam: d.familyName || '—',
          email: d.email || '',
          attending: d.attending === 'yes' ? 'yes' : 'no',
          guests: d.guestDetails || [],
          intolerances: d.intolerances || '',
          message: d.message || '',
          ts: d.timestamp ? d.timestamp.toDate() : null,
        });
      });

      // Stats
      const yesFamilies = families.filter(f => f.attending==='yes').length;
      const yesGuests   = families.filter(f=>f.attending==='yes').reduce((s,f)=> s + (f.guests?.length||0), 0);
      const noFamilies  = families.filter(f => f.attending==='no').length;
      const setTxt = (id, v) => { const el=document.getElementById(id); if (el) el.textContent=String(v); };
      setTxt('statYesFamilies', yesFamilies);
      setTxt('statYesGuests', yesGuests);
      setTxt('statNoFamilies', noFamilies);

      const listEl   = document.getElementById('rsvpList');
      const searchEl = document.getElementById('rsvpSearch');
      const sortEl   = document.getElementById('rsvpSort');
      let filter = 'all';
      let q = '';

      function render() {
        if (!listEl) return;
        listEl.innerHTML = '';
        let arr = families.slice();
        if (filter !== 'all') arr = arr.filter(f => f.attending === filter);
        if (q) {
          const lq = q.toLowerCase();
          arr = arr.filter(f => {
            const inGuests = (f.guests||[]).some(g => (g.name||'').toLowerCase().includes(lq));
            return f.fam.toLowerCase().includes(lq) || (f.email||'').toLowerCase().includes(lq) || inGuests;
          });
        }
        const sort = (sortEl && sortEl.value) || 'date_desc';
        arr.sort((a,b)=>{
          if (sort==='name_az') return a.fam.localeCompare(b.fam);
          const at = a.ts ? a.ts.getTime() : 0, bt = b.ts ? b.ts.getTime() : 0;
          return sort==='date_asc' ? at-bt : bt-at;
        });

        arr.forEach(f => {
          const card = document.createElement('div');
          card.className = 'rsvp-card';
          const count = (f.guests||[]).length;
          const dateStr = f.ts ? f.ts.toLocaleString('de-DE') : '-';
          card.innerHTML = `
            <header>
              <div class="rsvp-title">Familie ${f.fam} <span class="muted">(${count} Gäste)</span></div>
              <span class="badge ${f.attending==='yes'?'yes':'no'}">${f.attending==='yes'?'Zugesagt':'Abgesagt'}</span>
            </header>
            <div class="rsvp-body">
              <div class="rsvp-meta"><strong>Zeitstempel:</strong> ${dateStr}</div>
              <div class="rsvp-meta"><strong>E‑Mail:</strong> ${f.email || '–'}</div>
              <div class="rsvp-meta"><strong>Unverträglichkeiten:</strong> ${f.intolerances || '–'}</div>
              <div class="rsvp-meta"><strong>Nachricht:</strong> ${f.message || '–'}</div>
              <div class="chips">${(f.guests||[]).map(g=>`<span class="chip ${g.type==='Kind'?'kid':'adult'}">${g.name} · ${g.type}</span>`).join('')}</div>
            </div>`;
          listEl.appendChild(card);
        });
      }

      document.querySelectorAll('[data-rsvp]').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('[data-rsvp]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        filter = btn.dataset.rsvp;
        render();
      }));
      if (searchEl) searchEl.addEventListener('input', e => { q = e.target.value.trim(); render(); });
      if (sortEl) sortEl.addEventListener('change', render);

      const exportBtn = document.getElementById('rsvpExport');
      if (exportBtn) exportBtn.addEventListener('click', (e) => {
        e.preventDefault();
        let arr = families.slice();
        if (filter !== 'all') arr = arr.filter(f => f.attending === filter);
        if (q) {
          const lq = q.toLowerCase();
          arr = arr.filter(f => {
            const inGuests = (f.guests||[]).some(g => (g.name||'').toLowerCase().includes(lq));
            return f.fam.toLowerCase().includes(lq) || (f.email||'').toLowerCase().includes(lq) || inGuests;
          });
        }
        const rows = [['Familie','E-Mail','Teilnahme','Gäste','Unverträglichkeiten','Nachricht','Zeit']];
        arr.forEach(f => rows.push([
          f.fam,
          f.email,
          f.attending==='yes'?'Ja':'Nein',
          (f.guests||[]).map(g=>`${g.name} (${g.type})`).join('; '),
          f.intolerances || '',
          (f.message||'').replace(/\n/g,' '),
          f.ts ? f.ts.toISOString() : ''
        ]));
        const csv = rows.map(r=> r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='rsvps.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
      });

      render();
    }

    // ==========================
    // Gifts Admin
    // ==========================
    function initGiftsAdmin() {
      const section = document.getElementById('giftAdmin');
      const tbody = document.querySelector('#giftTable tbody');
      const form = document.getElementById('giftForm');
      const nameIn = document.getElementById('gName');
      const descIn = document.getElementById('gDesc');
      const linkIn = document.getElementById('gLink');
      const imgUrlIn = document.getElementById('gImgUrl');
      const imgFileIn = document.getElementById('gImgFile');
      const previewWrap = document.getElementById('gImgPreviewWrap');
      const previewImg  = document.getElementById('gImgPreview');
      const resetBtn = document.getElementById('giftReset');

      // Anzeige wird über Tabs gesteuert

      const FN_BASE = CONFIG.urls.functions + '/sendContactMail';

      let lastGiftDocs = [];
      let statusFilter = 'all';
      let queryText = '';

      function updateGiftStats(docs) {
        const total = docs.length;
        const reserved = docs.filter(d => d.data().reserved).length;
        const free = total - reserved;
        const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = String(v); };
        set('giftStatTotal', total);
        set('giftStatReserved', reserved);
        set('giftStatFree', free);
      }

      // Realtime Liste
      function reRenderGifts() {
        tbody.innerHTML = '';
        updateGiftStats(lastGiftDocs);
        const docs = lastGiftDocs.filter(d => {
          const reserved = !!d.data().reserved;
          const passesStatus = statusFilter === 'all' || (statusFilter === 'reserved' ? reserved : !reserved);
          if (!passesStatus) return false;
          if (!queryText) return true;
          const x = d.data();
          const s = `${x.name||''} ${x.description||''}`.toLowerCase();
          return s.includes(queryText);
        });
        docs.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement('tr');
          tr.dataset.reserved = d.reserved ? 'true' : 'false';
          const imgCell = document.createElement('td');
          const img = document.createElement('img');
          if (d.imgUrl) {
            const confBucket = firebase.app().options.storageBucket;
            const setSrc = (url) => { img.src = url; };
            if (d.imgUrl.startsWith('gs://')) {
              gsUrlToDownloadUrl(d.imgUrl, storage, confBucket)
                .then(setSrc)
                .catch(() => {});
            } else {
              setSrc(normalizeStorageUrl(d.imgUrl, confBucket));
            }
          }
          img.alt = d.name || '';
          imgCell.appendChild(img);
          tr.appendChild(imgCell);

          const nameCell = document.createElement('td');
          nameCell.textContent = d.name || '';
          tr.appendChild(nameCell);

          const descCell = document.createElement('td');
          descCell.textContent = d.description || '';
          tr.appendChild(descCell);

          const linkCell = document.createElement('td');
          if (d.link) {
            const a = document.createElement('a');
            a.href = d.link; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'Öffnen';
            linkCell.appendChild(a);
          } else { linkCell.textContent = '—'; }
          tr.appendChild(linkCell);

          const statusCell = document.createElement('td');
          const pill = document.createElement('span');
          if (d.reserved) {
            pill.textContent = `Reserviert${d.reserverEmail ? ' ('+d.reserverEmail+')' : ''}`;
            pill.className = 'status-pill status-res';
          } else {
            pill.textContent = 'Frei'; pill.className = 'status-pill status-ok';
          }
          statusCell.appendChild(pill);
          tr.appendChild(statusCell);

          const actCell = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Löschen';
          delBtn.className = 'danger';
          delBtn.addEventListener('click', async () => {
            if (!confirm('Geschenk wirklich löschen?')) return;
            try {
              await db.collection('gifts').doc(doc.id).delete();
              toast.success('Geschenk erfolgreich gelöscht');
            } catch (e) {
              console.error('Delete error:', e);
              toast.error('Fehler beim Löschen: ' + e.message);
            }
          });

          actCell.appendChild(delBtn);

          if (d.reserved) {
            const resetRes = document.createElement('button');
            resetRes.textContent = 'Reservierung zurücksetzen';
            resetRes.style.marginLeft = '0.5rem';
            resetRes.addEventListener('click', async () => {
              if (!confirm('Reservierung für dieses Geschenk wirklich zurücksetzen?')) return;
              try {
                await db.collection('gifts').doc(doc.id).update({
                  reserved: false,
                  reserverEmail: firebase.firestore.FieldValue.delete(),
                  reservedAt: firebase.firestore.FieldValue.delete(),
                  token: firebase.firestore.FieldValue.delete()
                });
                toast.success('Reservierung erfolgreich zurückgesetzt');
              } catch (e) {
                console.error('Reset error:', e);
                toast.error('Fehler beim Zurücksetzen: ' + e.message);
              }
            });
            actCell.appendChild(resetRes);
          }

          tr.appendChild(actCell);
          tbody.appendChild(tr);
        });
      }

      db.collection('gifts').orderBy('createdAt', 'desc').onSnapshot(snap => {
        lastGiftDocs = snap.docs;
        reRenderGifts();
      });

      // Filters
      const searchEl = document.getElementById('giftSearch');
      if (searchEl) searchEl.addEventListener('input', (e) => { queryText = e.target.value.trim().toLowerCase(); reRenderGifts(); });
      document.querySelectorAll('.pill-group .pill').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.pill-group .pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        statusFilter = btn.dataset.status;
        reRenderGifts();
      }));

      // Submit: Hinzufügen
      function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });
      }

      async function resolveDisplayUrl(url) {
        if (!url) return null;
        try {
          if (url.startsWith('gs://')) {
            const confBucket = firebase.app().options.storageBucket;
            const normalizedGs = url.replace(/^gs:\/\/[^\/]+\//, `gs://${confBucket}/`);
            const u = await storage.refFromURL(normalizedGs).getDownloadURL();
            return u;
          }
          return url;
        } catch { return null; }
      }

      async function showPreviewFrom(url) {
        const display = await resolveDisplayUrl(url);
        if (display) {
          previewImg.src = display;
          previewWrap.style.display = 'flex';
        }
      }

      async function autoFetchImageFromLink() {
        const link = linkIn.value.trim();
        if (!link) return;
        // nur wenn kein eigenes Bild gewählt/gesetzt ist
        if (imgFileIn.files?.length || imgUrlIn.value.trim()) return;
        try {
          const res = await fetch(`${FN_BASE}/resolveProductImage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: link }) });
          const data = await res.json().catch(()=>({}));
          if (!res.ok || !data.imageUrl) return;
          // Bild in Storage importieren für Stabilität
          const imp = await fetch(`${FN_BASE}/importImageToStorage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageUrl: data.imageUrl }) });
          const impData = await imp.json().catch(()=>({}));
          if (imp.ok && impData.downloadUrl) {
            imgUrlIn.value = impData.downloadUrl;
          } else {
            imgUrlIn.value = data.imageUrl; // Fallback: direkte URL verwenden
          }
          // Prefill Name/Beschreibung falls leer
          if (!nameIn.value.trim() && data.title) nameIn.value = data.title;
          if (!descIn.value.trim() && data.description) descIn.value = data.description;
          // Preview zeigen
          showPreviewFrom(imgUrlIn.value.trim());
        } catch (e) {
          console.warn('Auto-Fetch Bild fehlgeschlagen', e);
        }
      }

      const fetchBtn = document.getElementById('fetchImgBtn');
      function setBtnLoading(b){ if(!fetchBtn) return; fetchBtn.disabled=b; fetchBtn.textContent=b? 'Bild wird geholt…' : 'Bild aus Link holen'; }
      async function handleFetchClick(){ setBtnLoading(true); await autoFetchImageFromLink(); setBtnLoading(false); if(!imgUrlIn.value.trim()) alert('Kein Bild gefunden. Tipp: m.amazon-Link probieren oder Bild-Adresse direkt einfügen.'); }
      if (fetchBtn) fetchBtn.addEventListener('click', handleFetchClick);
      linkIn.addEventListener('change', autoFetchImageFromLink);
      linkIn.addEventListener('blur', autoFetchImageFromLink);
      imgUrlIn.addEventListener('change', () => showPreviewFrom(imgUrlIn.value.trim()));
      imgFileIn.addEventListener('change', async () => {
        const f = imgFileIn.files && imgFileIn.files[0];
        if (!f) return;
        const dataUrl = await fileToDataUrl(f);
        previewImg.src = dataUrl;
        previewWrap.style.display = 'flex';
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = nameIn.value.trim();
        const description = descIn.value.trim();
        const link = linkIn.value.trim();
        const urlFromInput = imgUrlIn.value.trim();
        const file = imgFileIn.files && imgFileIn.files[0];

        if (!name) {
          toast.error('Bitte gib einen Namen für das Geschenk ein');
          return;
        }

        if (name.length < 3) {
          toast.error('Der Name muss mindestens 3 Zeichen lang sein');
          return;
        }

        if (link && !link.match(/^https?:\/\/.+/)) {
          toast.error('Bitte gib einen gültigen Link ein (mit http:// oder https://)');
          return;
        }

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Wird gespeichert...';

        let finalImgUrl = urlFromInput || '';
        try {
          if (file) {
            // Primär: Upload via Cloud Function (vermeidet Storage-CORS)
            try {
              const dataUrl = await fileToDataUrl(file);
              const resp = await fetch(`${FN_BASE}/uploadGiftImage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, contentType: file.type || 'application/octet-stream', dataUrl })
              });
              const data = await resp.json().catch(() => ({}));
              if (!resp.ok) throw new Error(data?.message || 'Upload API Fehler');
              // Bevorzuge die tokenisierte Download-URL, damit Public-Read-Regeln nicht nötig sind
              finalImgUrl = data.downloadUrl || data.gsUrl || '';
            } catch (uploadErr) {
              console.warn('Upload via Function fehlgeschlagen, versuche direkten Storage-Upload …', uploadErr);
              // Fallback: direkter Upload auf Standard‑Bucket (benötigt CORS)
              const safeName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
              const ref = storage.ref().child(`gifts/${Date.now()}_${safeName}`);
              const snap = await ref.put(file);
              // Speichere gs:// Pfad, nicht nur die Download-URL
              finalImgUrl = ref.toString();
            }
          }

          await db.collection('gifts').add({
            name,
            description: description || null,
            link: link || null,
            imgUrl: finalImgUrl || null,
            reserved: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          toast.success('Geschenk erfolgreich hinzugefügt');
          form.reset();
          previewWrap.style.display = 'none';

        } catch (err) {
          console.error('Save error:', err);
          toast.error('Fehler beim Speichern: ' + err.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });

      resetBtn.addEventListener('click', () => form.reset());
    }
  </script>
</body>
</html>
