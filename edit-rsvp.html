<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSVP bearbeiten – Unsere Hochzeit</title>

  <!-- Farbvariablen und Basis-Styles -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/basic.css">
  <!-- Spezifisches Styling für RSVP (kopiert aus rsvp.css) -->
  <link rel="stylesheet" href="css/edit-rsvp.css">

  <!-- jQuery für Header/Footer-Include -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="js/includeTemplate.js"></script>

  <!-- Firebase-SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBghkLs0tkWZjdMQC9RvDT8DmC5J-uXpEc",
      authDomain: "hochzeiteduardjoanne.firebaseapp.com",
      projectId: "hochzeiteduardjoanne",
      storageBucket: "hochzeiteduardjoanne.firebasestorage.app",
      messagingSenderId: "209565556740",
      appId: "1:209565556740:web:1a227bfce08bf5dca2d551"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Query-Param aus URL lesen
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    const rsvpId = getParam('id');
    const form = document.getElementById('edit-form');
    const guestsInput = document.getElementById('guests');
    const detailsContainer = document.getElementById('guest-details');

    // Daten laden
    db.collection('rsvps').doc(rsvpId).get().then(doc => {
      if (!doc.exists) {
        alert('RSVP nicht gefunden.');
        return;
      }
      const data = doc.data();
      form.familyName.value   = data.familyName;
      form.attending.value    = data.attending;
      form.guests.value       = data.guests;
      form.intolerances.value = data.intolerances || '';
      form.message.value      = data.message || '';
      renderGuestFields(data.guestDetails);
    }).catch(err => {
      console.error(err);
      alert('Fehler beim Laden.');
    });

    // Render Gast-Felder aus Array
    function renderGuestFields(guestDetails) {
      detailsContainer.innerHTML = '';
      guestDetails.forEach((gd, i) => {
        const wrapper = document.createElement('div');
        wrapper.classList.add('form-group');
        wrapper.innerHTML = `
          <label>Gast ${i+1} (Vorname)</label>
          <input type="text" name="guestName_${i+1}" value="${gd.name}" required>
          <div class="radio-group">
            <label><input type="radio" name="guestType_${i+1}" value="Erwachsener" ${gd.type==='Erwachsener'? 'checked':''}> Erwachsener</label>
            <label><input type="radio" name="guestType_${i+1}" value="Kind" ${gd.type==='Kind'? 'checked':''}> Kind</label>
            <label><input type="radio" name="guestType_${i+1}" value="Kleinkind" ${gd.type==='Kleinkind'? 'checked':''}> Kleinkind</label>
          </div>
        `;
        detailsContainer.appendChild(wrapper);
      });
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const count = parseInt(form.guests.value, 10) || 1;
      const guestDetails = [];
      for (let i = 1; i <= count; i++) {
        const name = form[`guestName_${i}`]?.value.trim() || '';
        const type = form[`guestType_${i}`]?.value;
        guestDetails.push({ name, type });
      }
      const updated = {
        familyName:   form.familyName.value.trim(),
        attending:    form.attending.value,
        guests:       count,
        guestDetails: guestDetails,
        intolerances: form.intolerances.value.trim(),
        message:      form.message.value.trim()
      };
      try {
        await db.collection('rsvps').doc(rsvpId).update(updated);
        alert('Deine RSVP wurde aktualisiert!');
      } catch (err) {
        console.error(err);
        alert('Fehler beim Speichern.');
      }
    });
  </script>
</head>
<body>
  <div id="header"></div>

  <section class="rsvp-section">
    <h2>RSVP bearbeiten</h2>
    <form id="edit-form" class="rsvp-form">
      <div class="form-group">
        <label for="familyName">Familienname</label>
        <input type="text" id="familyName" name="familyName" placeholder="Dein Familienname" required>
      </div>

      <div class="form-group">
        <label>Teilnahme</label>
        <label><input type="radio" name="attending" value="yes" required> Ja</label>
        <label><input type="radio" name="attending" value="no"  required> Nein</label>
      </div>

      <div class="form-group">
        <label for="guests">Gäste insgesamt</label>
        <input type="number" id="guests" name="guests" min="1" max="10" value="1">
      </div>

      <div class="form-group age-description">
        <p><strong>Alterskategorien:</strong></p>
        <div class="age-list">
          <p>Erwachsener ab 16 Jahren</p>
          <p>Kind 6 bis 15 Jahre</p>
          <p>Kleinkind bis 5 Jahre</p>
        </div>
      </div>

      <div id="guest-details"></div>

      <div class="form-group">
        <label for="intolerances">Unverträglichkeiten</label>
        <textarea id="intolerances" name="intolerances" rows="2" placeholder="z. B. Gluten, Laktose, Nüsse…"></textarea>
      </div>

      <div class="form-group">
        <label for="message">Nachricht</label>
        <textarea id="message" name="message" rows="4"></textarea>
      </div>

      <button type="submit" class="btn">Änderungen speichern</button>
    </form>
  </section>

  <div id="footer"></div>
</body>
</html>
