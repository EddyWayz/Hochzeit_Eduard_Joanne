<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSVP â€“ Bearbeiten</title>

  <!-- Farbvariablen und Basisâ€‘Styles -->
  <link rel="stylesheet" href="assets/css/variables.css">
  <link rel="stylesheet" href="assets/css/basic.css">
  <!-- Spezifisches Styling fÃ¼r RSVP -->
  <link rel="stylesheet" href="assets/css/rsvp.css">
  <!-- Toast Notifications -->
  <link rel="stylesheet" href="assets/css/toast.css">

  <!-- Header/Footer Include (vanilla) -->
  <script defer src="assets/js/includeTemplate.js"></script>

  <!-- Configuration -->
  <script src="config.js"></script>

  <!-- Utilities -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/toast.js"></script>

  <!-- Firebase SDKs (Updated to v11) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <script>
    firebase.initializeApp(CONFIG.firebase);
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div id="header"></div>

  <!-- RSVP-Seite: Modernes Zusageformular mit dynamischen Gastfeldern -->
  <section class="rsvp-section">
    <div class="rsvp-container">
      <h2>RSVP bearbeiten</h2>
      <p class="rsvp-intro">Hier kannst du deine Zusage bearbeiten.</p>
      
      <form class="rsvp-form" id="edit-form">
        <!-- Familienname -->
        <div class="form-group">
          <label for="familyName">Familienname</label>
          <input type="text" id="familyName" name="familyName" placeholder="Dein Familienname" required>
        </div>

        <!-- Eâ€‘Mail -->
        <div class="form-group">
          <label for="email">Eâ€‘Mail</label>
          <input type="email" id="email" name="email" placeholder="deine@mail.de" required>
        </div>

        <!-- Teilnahme -->
        <div class="form-group">
          <label>Teilnahme</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="attending" value="yes" required>
              <span>Ja, ich komme</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="attending" value="no" required>
              <span>Nein, ich kann leider nicht</span>
            </label>
          </div>
        </div>

        <!-- Begleitpersonen -->
        <div class="form-group guests-form-group">
          <label for="guests">Anzahl der GÃ¤ste</label>
          <div class="guests-input">
            <button type="button" class="guest-btn" id="decrease-guests">-</button>
            <input type="number" id="guests" name="guests" min="1" max="5" value="1" readonly>
            <button type="button" class="guest-btn" id="increase-guests">+</button>
          </div>
        </div>

        <!-- Alterskategorien Info -->
        <div class="form-group age-info">
          <h3>Alterskategorien</h3>
          <div class="age-list">
            <div class="age-item">
              <span class="age-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
              <span class="age-text">Erwachsener ab 16 Jahren</span>
            </div>
            <div class="age-item">
              <span class="age-icon">ğŸ‘§</span>
              <span class="age-text">Kind 6 bis 15 Jahre</span>
            </div>
            <div class="age-item">
              <span class="age-icon">ğŸ‘¶</span>
              <span class="age-text">Kleinkind bis 5 Jahre</span>
            </div>
          </div>
        </div>

        <!-- Container fÃ¼r dynamische Gast-Felder -->
        <div id="guest-details" class="guest-details"></div>

        <!-- UnvertrÃ¤glichkeiten -->
        <div class="form-group intolerances-form-group">
          <label for="intolerances">UnvertrÃ¤glichkeiten</label>
          <textarea id="intolerances" name="intolerances" rows="2" placeholder="z. B. Gluten, Laktose, NÃ¼sseâ€¦"></textarea>
        </div>

        <!-- Nachricht -->
        <div class="form-group message-form-group">
          <label for="message">Nachricht</label>
          <textarea id="message" name="message" rows="4" placeholder="MÃ¶chtest du uns noch etwas mitteilen?"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Ã„nderungen speichern</button>
      </form>
    </div>
  </section>

  <script>
    // Helfer: Query-Parameter aus URL
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    // Wrap in async IIFE to allow return statements
    (async function() {
      const rsvpId = getParam('id');
      const form = document.getElementById('edit-form');
      const guestsInput = document.getElementById('guests');
      const detailsContainer = document.getElementById('guest-details');
      const decreaseBtn = document.getElementById('decrease-guests');
      const increaseBtn = document.getElementById('increase-guests');

    // Funktion zum Sammeln der aktuellen Gastdaten aus dem Formular
    function getCurrentGuestData() {
      const currentCount = parseInt(guestsInput.value);
      const guestData = [];

      for (let i = 1; i <= currentCount; i++) {
        const nameField = document.getElementById(`guestName_${i}`);
        const typeField = document.querySelector(`input[name="guestType_${i}"]:checked`);

        if (nameField) {
          guestData.push({
            name: nameField.value || '',
            type: typeField ? typeField.value : 'Erwachsener'
          });
        }
      }

      return guestData;
    }

    function renderGuestFields(count, guestDetails = []) {
      detailsContainer.innerHTML = '';
      const isDisabled = document.querySelector('input[name="attending"]:checked')?.value === 'no';
      
      for (let i = 1; i <= count; i++) {
        const data = guestDetails[i-1] || { name: '', type: 'Erwachsener' };
        const wrapper = document.createElement('div');
        wrapper.classList.add('guest-field');
        if (isDisabled) wrapper.classList.add('disabled');
        
        wrapper.innerHTML = `
          <div class="guest-header">
            <h3>Gast ${i}</h3>
          </div>
          <div class="guest-content">
            <div class="form-group">
              <label for="guestName_${i}">Vorname</label>
              <input type="text" id="guestName_${i}" name="guestName_${i}" 
                     placeholder="Vorname Gast ${i}" value="${data.name}" required ${isDisabled ? 'disabled' : ''}>
            </div>
            <div class="form-group">
              <label>Alterskategorie</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="guestType_${i}" value="Erwachsener" 
                         ${data.type==='Erwachsener'? 'checked':''} ${isDisabled ? 'disabled' : ''}>
                  <span>Erwachsener</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="guestType_${i}" value="Kind" 
                         ${data.type==='Kind'? 'checked':''} ${isDisabled ? 'disabled' : ''}>
                  <span>Kind</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="guestType_${i}" value="Kleinkind" 
                         ${data.type==='Kleinkind'? 'checked':''} ${isDisabled ? 'disabled' : ''}>
                  <span>Kleinkind</span>
                </label>
              </div>
            </div>
          </div>
        `;
        detailsContainer.appendChild(wrapper);
      }
    }

    // Funktion zum Aktivieren/Deaktivieren der Formularfelder
    function toggleFormFields(disable) {
      const fieldsToToggle = [
        '#guests',
        '#decrease-guests',
        '#increase-guests',
        '#intolerances',
        '#message'
      ];
      
      // Hauptfelder togglen
      fieldsToToggle.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
          element.disabled = disable;
        }
      });
      
      // Gast-Detail-Felder togglen
      const guestFields = document.querySelectorAll('#guest-details input, #guest-details textarea');
      guestFields.forEach(field => {
        field.disabled = disable;
      });
      
      // Container-Klasse fÃ¼r visuelles Styling
      const guestDetailsContainer = document.getElementById('guest-details');
      const guestsFormGroup = document.querySelector('.guests-form-group');
      const ageInfoGroup = document.querySelector('.age-info');
      const intolerancesGroup = document.querySelector('.intolerances-form-group');
      const messageGroup = document.querySelector('.message-form-group');
      
      [guestDetailsContainer, guestsFormGroup, ageInfoGroup, intolerancesGroup, messageGroup].forEach(container => {
        if (container) {
          if (disable) {
            container.classList.add('disabled');
          } else {
            container.classList.remove('disabled');
          }
        }
      });
    }

    // Event Listener fÃ¼r Guest Counter
    decreaseBtn.addEventListener('click', () => {
      const currentValue = parseInt(guestsInput.value);
      if (currentValue > 1) {
        // Aktuelle Daten sichern bevor wir neu rendern
        const currentData = getCurrentGuestData();
        guestsInput.value = currentValue - 1;
        renderGuestFields(currentValue - 1, currentData);
      }
    });

    increaseBtn.addEventListener('click', () => {
      const currentValue = parseInt(guestsInput.value);
      if (currentValue < 5) {
        // Aktuelle Daten sichern bevor wir neu rendern
        const currentData = getCurrentGuestData();
        guestsInput.value = currentValue + 1;
        renderGuestFields(currentValue + 1, currentData);
      }
    });

    // Event Listener fÃ¼r Teilnahme Radio Buttons
    document.querySelectorAll('input[name="attending"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const isNotAttending = this.value === 'no';
        toggleFormFields(isNotAttending);

        // Aktuelle Daten sichern und Felder neu rendern
        const currentData = getCurrentGuestData();
        renderGuestFields(parseInt(guestsInput.value), currentData);
      });
    });

    // Daten laden und Formular befÃ¼llen
    if (!rsvpId) {
      toast.error('Keine RSVP-ID gefunden. Bitte verwende den Link aus deiner E-Mail.');
      return;
    }

    db.collection('rsvps').doc(rsvpId).get().then(doc => {
      if (!doc.exists) {
        toast.error('RSVP nicht gefunden. Bitte Ã¼berprÃ¼fe den Link aus deiner E-Mail.');
        return;
      }
      const data = doc.data();

      // Basis-Formularfelder setzen
      form.familyName.value   = data.familyName || '';
      form.email.value        = data.email || '';
      guestsInput.value       = data.guests || 1;
      form.intolerances.value = data.intolerances || '';
      form.message.value      = data.message || '';

      // Radio-Button fÃ¼r Teilnahme korrekt setzen (nicht mit .value!)
      const attendingRadio = document.querySelector(`input[name="attending"][value="${data.attending}"]`);
      if (attendingRadio) {
        attendingRadio.checked = true;
      } else {
        console.warn('Attending radio button not found for value:', data.attending);
      }

      // Erst nach dem Setzen der Radio-Buttons die Felder togglen
      const isNotAttending = data.attending === 'no';
      toggleFormFields(isNotAttending);

      // Danach die Gastfelder mit den geladenen Daten rendern
      renderGuestFields(data.guests || 1, data.guestDetails || []);

    }).catch(err => {
      console.error('Fehler beim Laden der RSVP-Daten:', err);
      console.error('Error details:', {
        code: err.code,
        message: err.message,
        rsvpId: rsvpId
      });

      let errorMessage = 'Fehler beim Laden der Daten. Bitte versuche es spÃ¤ter erneut.';

      if (err.code === 'permission-denied') {
        errorMessage = 'Zugriff verweigert. Bitte Ã¼berprÃ¼fe den Link aus deiner E-Mail.';
      } else if (err.code === 'not-found') {
        errorMessage = 'RSVP nicht gefunden. Bitte Ã¼berprÃ¼fe den Link aus deiner E-Mail.';
      } else if (err.code === 'unavailable') {
        errorMessage = 'Der Service ist momentan nicht erreichbar. Bitte versuche es spÃ¤ter erneut.';
      }

      toast.error(errorMessage);
    });

    // Submit: in Firestore updaten
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');

      // Radio-Button korrekt auslesen (nicht mit .value!)
      const attendingChecked = document.querySelector('input[name="attending"]:checked');
      const attending = attendingChecked ? attendingChecked.value : 'yes';

      // Validierung
      if (!e.target.familyName.value.trim() || e.target.familyName.value.trim().length < 2) {
        toast.error('Bitte gib einen gÃ¼ltigen Familiennamen ein (mindestens 2 Zeichen)');
        return;
      }

      if (!e.target.email.value.trim() || !e.target.email.value.includes('@')) {
        toast.error('Bitte gib eine gÃ¼ltige E-Mail-Adresse ein');
        return;
      }

      submitBtn.disabled = true;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Wird gespeichert...';

      const guestCount = parseInt(guestsInput.value) || 1;
      const guestDetails = [];

      // Validiere Gastnamen nur wenn attending === 'yes'
      if (attending === 'yes') {
        for (let i = 1; i <= guestCount; i++) {
          const nameField = e.target[`guestName_${i}`];
          const typeField = e.target[`guestType_${i}`];

          if (!nameField || !nameField.value.trim()) {
            toast.error(`Bitte gib einen Namen fÃ¼r Gast ${i} ein`);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
          }

          guestDetails.push({
            name: nameField.value.trim(),
            type: typeField.value
          });
        }
      }

      const updated = {
        familyName:   e.target.familyName.value.trim(),
        email:        e.target.email.value.trim().toLowerCase(),
        attending:    attending,
        guests:       attending === 'yes' ? guestCount : 0,
        guestDetails: attending === 'yes' ? guestDetails : [],
        intolerances: attending === 'yes' ? e.target.intolerances.value.trim() : '',
        message:      e.target.message.value.trim()
      };

      try {
        await db.collection('rsvps').doc(rsvpId).update(updated);
        toast.success('Deine RSVP wurde erfolgreich aktualisiert! âœ“');
      } catch (error) {
        console.error('Fehler beim Speichern:', error);

        let errorMessage = 'Fehler beim Speichern. Bitte versuche es spÃ¤ter erneut.';

        if (error.code === 'permission-denied') {
          errorMessage = 'Zugriff verweigert. Bitte Ã¼berprÃ¼fe deine Eingaben und versuche es erneut.';
        } else if (error.code === 'not-found') {
          errorMessage = 'RSVP nicht gefunden. Bitte Ã¼berprÃ¼fe den Link aus deiner E-Mail.';
        } else if (error.code === 'unavailable') {
          errorMessage = 'Der Service ist momentan nicht erreichbar. Bitte versuche es spÃ¤ter erneut.';
        } else if (error.code === 'invalid-argument') {
          errorMessage = 'UngÃ¼ltige Eingaben. Bitte Ã¼berprÃ¼fe deine Daten.';
        }

        toast.error(errorMessage);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ã„nderungen speichern';
      }
    });
    })(); // End of async IIFE
  </script>

  <div id="footer"></div>
</body>
</html>
