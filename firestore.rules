rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.email != null;
    }

    // RSVP Collection Rules
    // - Anyone can create (submit) an RSVP
    // - Anyone can read RSVPs (needed for edit functionality)
    // - Only the document creator can update their own RSVP
    // - Only admins can delete RSVPs
    match /rsvps/{rsvpId} {
      allow create: if true
                    && request.resource.data.keys().hasAll(['familyName', 'email', 'attending', 'timestamp'])
                    && request.resource.data.familyName is string
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('.*@.*\\..*')
                    && request.resource.data.attending in ['yes', 'no']
                    && request.resource.data.guests is int
                    && request.resource.data.guests >= 1
                    && request.resource.data.guests <= 10;

      allow read: if true;

      allow update: if true
                    && request.resource.data.familyName == resource.data.familyName
                    && request.resource.data.email == resource.data.email;

      allow delete: if isAdmin();
    }

    // Gifts Collection Rules
    // - Anyone can read gifts
    // - Only authenticated admins can create gifts
    // - Anyone can update to reserve (but only once, from unreserved to reserved)
    // - Only admins can fully update or unreserve gifts
    // - Only admins can delete gifts
    match /gifts/{giftId} {
      allow read: if true;

      allow create: if isAdmin()
                    && request.resource.data.keys().hasAll(['name', 'reserved', 'createdAt'])
                    && request.resource.data.name is string
                    && request.resource.data.reserved == false;

      // Allow reservation: change from unreserved to reserved
      allow update: if (!resource.data.reserved && request.resource.data.reserved)
                    && request.resource.data.keys().hasAll(['reserved', 'reserverEmail'])
                    && request.resource.data.reserverEmail is string
                    && request.resource.data.reserverEmail.matches('.*@.*\\..*')
                    || isAdmin();

      allow delete: if isAdmin();
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
